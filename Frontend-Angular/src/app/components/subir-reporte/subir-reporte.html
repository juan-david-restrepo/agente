<app-nav></app-nav>

<div class="contenedor-form">
  <form (ngSubmit)="enviarReporte()" #reporteForm="ngForm">

    <h2>Reportar Incidente</h2>

    <!-- ============================= -->
    <!-- TIPO DE INCIDENTE -->
    <!-- ============================= -->
    <div class="seccion">
      <label>Tipo de incidente *</label>

      <div class="grid-incidentes">
        <div 
          *ngFor="let incidente of incidentes"
          class="card-incidente"
          [class.selected]="tipoSeleccionado === incidente.nombre"
          (click)="seleccionarIncidente(incidente)"
        >
          {{ incidente.nombre }}
        </div>
      </div>

      <!-- Campo Otros -->
      <div *ngIf="mostrarCampoOtros" class="campo-otros">
        <input
          type="text"
          name="detalleOtro"
          [(ngModel)]="detalleOtroIncidente"
          placeholder="Especifica el tipo de incidente"
          required
        />
      </div>
    </div>

    <!-- ============================= -->
    <!-- DESCRIPCIÓN -->
    <!-- ============================= -->
    <div class="seccion">
      <label>Descripción *</label>
      <textarea
        name="descripcion"
        [(ngModel)]="descripcion"
        maxlength="300"
        required
        placeholder="Describe lo sucedido con el mayor detalle posible"
      ></textarea>
      <small>{{ descripcion?.length || 0 }}/300</small>
    </div>

    <!-- ============================= -->
    <!-- FECHA Y HORA -->
    <!-- ============================= -->
    <div class="seccion fila">
      <div>
        <label>Fecha *</label>
        <input
          type="date"
          name="fecha"
          [(ngModel)]="fecha"
          required
        />
      </div>

      <div>
        <label>Hora *</label>
        <input
          type="time"
          name="hora"
          [(ngModel)]="hora"
          required
        />
      </div>
    </div>

    <!-- ============================= -->
    <!-- PLACA (DINÁMICA) -->
    <!-- ============================= -->
    <div class="seccion" *ngIf="requierePlacaActual || placaOpcional">
  <label>
    Placa del vehículo 
    <span *ngIf="requierePlacaActual">*</span>
  </label>

  <input
    type="text"
    name="placa"
    [(ngModel)]="placa"
    placeholder="ABC123"
    maxlength="6"
    [required]="requierePlacaActual"
  />

  <small *ngIf="placaOpcional">
    Opcional. Si la ingresas debe tener formato válido.
  </small>

  <small *ngIf="requierePlacaActual">
    Formato válido: ABC123
  </small>
</div>

    <!-- ============================= -->
    <!-- ARCHIVOS -->
    <!-- ============================= -->
    <div class="seccion">
      <label>Adjuntar imágenes o videos (máx 5)</label>
      <input
        type="file"
        multiple
        (change)="onFileChange($event)"
      />

      <div class="preview-container">
        <div
          class="preview-item"
          *ngFor="let file of fileList; let i = index"
        >
          <button
            type="button"
            class="remove-btn"
            (click)="removeFile(i)"
          >
            ×
          </button>

          <img
            *ngIf="file.type.startsWith('image')"
            [src]="getPreviewUrl(file)"
          />

          <video
            *ngIf="file.type.startsWith('video')"
            [src]="getPreviewUrl(file)"
            controls
          ></video>
        </div>
      </div>
    </div>

    <!-- ============================= -->
    <!-- UBICACIÓN -->
    <!-- ============================= -->
    <div class="seccion">
      <button
        type="button"
        (click)="obtenerUbicacion()"
      >
        Obtener ubicación
      </button>

      <p *ngIf="direccion">
        <strong>Dirección detectada:</strong> {{ direccion }}
      </p>

      <div id="map"></div>
    </div>

    <!-- ============================= -->
    <!-- BOTÓN ENVIAR -->
    <!-- ============================= -->
    <button
      type="submit"
      class="btn-enviar"
      [disabled]="!formularioValido() || isSubmitting"
    >
      {{ isSubmitting ? 'Enviando...' : 'Enviar Reporte' }}
    </button>

  </form>
</div>